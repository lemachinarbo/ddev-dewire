#!/usr/bin/env bash
#ddev-generated
## Description: Update environment folder structure on the remote server
## Usage: cpw-transform [ENV]

set -euo pipefail
trap 'log_error "Command \"$BASH_COMMAND\" failed at line $LINENO"; exit 1' ERR

# Source common logging/colors and helpers
source "$(dirname "$0")/lib/common.sh"

if [[ "${1:-}" == "--help" ]]; then
    echo "cpw-transform: Update environment folder structure on the remote server."
    echo "Usage: ddev cpw-transform [ENV]"
    exit 0
fi

main() {
    check_env_file_exists
    load_env_vars "$@"
    update_folder_structure
}

load_env_vars() {
    load_standard_env_vars "$@"
    load_ssh_vars
    load_remote_vars
}

update_folder_structure() {
    if [ -z "$REMOTE_USER" ] || [ -z "$REMOTE_HOST" ] || [ -z "$REMOTE_PATH" ]; then
        log_fatal "One or more required variables (SSH_USER, SSH_HOST, DEPLOY_PATH) are empty. Check your .env file for ${ENV}_SSH_USER, ${ENV}_SSH_HOST, and ${ENV}_PATH."
        exit 1
    fi
    ssh -i "$SSH_KEY_PATH" "$REMOTE_USER@$REMOTE_HOST" "cd $REMOTE_PATH && php RockShell/rock rm:transform && find . -type d -exec chmod 755 {} \; && find . -type f -exec chmod 644 {} \;"
}

main "$@"
